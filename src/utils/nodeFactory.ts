// src/utils/nodeFactory.ts
// å¼•å…¥ React Flow çš„æ ¸å¿ƒç±»å‹å®šä¹‰ï¼šNode(èŠ‚ç‚¹) å’Œ Edge(è¿çº¿)
import type { Node, Edge } from 'reactflow';
// å¼•å…¥ UUID ç”Ÿæˆå™¨ï¼Œç”¨äºç»™æ¯æ¡è¿çº¿ç”Ÿæˆå”¯ä¸€ ID
import { v4 as uuidv4 } from 'uuid';
// å¼•å…¥å…¨å±€å¸¸é‡é…ç½®ï¼Œç”¨äºä¿æŒæ ·å¼å’Œå¸ƒå±€çš„ç»Ÿä¸€æ€§
import { LAYOUT_CONFIG, STYLES } from '../constants';
// å¼•å…¥è‡ªå®šä¹‰çš„ä¸šåŠ¡æ•°æ®ç±»å‹å®šä¹‰
import type { QABlockData, NodeCallbacks } from '../types';

// å®šä¹‰ NodeFactory å¯¹è±¡ï¼Œä½œä¸ºåˆ›å»ºå›¾è¡¨å…ƒç´ çš„ç»Ÿä¸€å…¥å£
export const NodeFactory = {
    // =========================================================================
    // 1. åˆ›å»ºé—®ç­”èŠ‚ç‚¹ (Chat Node)
    // èŒè´£ï¼šç”Ÿæˆæ ‡å‡†çš„é—®ç­”èŠ‚ç‚¹æ•°æ®ç»“æ„ï¼ŒåŒ…å«è¾“å…¥çŠ¶æ€ã€å›è°ƒå‡½æ•°ç»‘å®šç­‰
    // =========================================================================
    createChat: (
        id: string,                 // èŠ‚ç‚¹çš„å”¯ä¸€ ID
        pos: {x: number, y: number},// èŠ‚ç‚¹åœ¨ç”»å¸ƒä¸Šçš„åæ ‡ (å¯ä»¥æ˜¯ç»å¯¹åæ ‡ï¼Œä¹Ÿå¯ä»¥æ˜¯ç›¸å¯¹äºçˆ¶åˆ†ç»„çš„åæ ‡)
        data: Partial<QABlockData>, // éƒ¨åˆ†åˆå§‹æ•°æ® (å¦‚ question, status ç­‰)
        callbacks: NodeCallbacks,   // å¿…é¡»æ³¨å…¥çš„å›è°ƒå‡½æ•° (onAsk, onExtend ç­‰)
        parentId?: string           // å¯é€‰ï¼šçˆ¶èŠ‚ç‚¹ ID (é€šå¸¸æ˜¯åˆ†ç»„èŠ‚ç‚¹çš„ ID)
    ): Node<QABlockData> => ({      // è¿”å›ç¬¦åˆ React Flow æ ‡å‡†çš„ Node å¯¹è±¡
        id,                         // èµ‹å€¼ ID
        type: 'chatNode',           // æŒ‡å®šèŠ‚ç‚¹ç±»å‹ï¼Œå¯¹åº” App.tsx ä¸­çš„ nodeTypes.chatNode
        position: pos,              // èµ‹å€¼ä½ç½®
        parentNode: parentId,       // ç»‘å®šçˆ¶å­å…³ç³» (å®ç°èŠ‚ç‚¹è·Ÿéšåˆ†ç»„æ‹–æ‹½çš„å…³é”®)
        extent: undefined,          // æ‹–æ‹½èŒƒå›´é™åˆ¶ (undefined è¡¨ç¤ºä¸é™åˆ¶)
        draggable: true,            // å…è®¸ç”¨æˆ·æ‹–æ‹½
        selectable: true,           // å…è®¸ç”¨æˆ·é€‰ä¸­
        style: { width: STYLES.NODE_WIDTH }, // è®¾ç½®èŠ‚ç‚¹å®½åº¦ (é€šå¸¸æ˜¯å›ºå®šçš„)
        data: {
            question: '',           // é»˜è®¤é—®é¢˜ä¸ºç©º
            answer: '',             // é»˜è®¤å›ç­”ä¸ºç©º
            status: 'input',        // é»˜è®¤çŠ¶æ€ä¸º 'input' (è¾“å…¥æ€)
            superBlockId: '',       // é»˜è®¤è¶…çº§å— ID ä¸ºç©º
            isLast: true,           // é»˜è®¤æ˜¯è¯¥åˆ†æ”¯æœ€åä¸€ä¸ªèŠ‚ç‚¹ (æ˜¾ç¤ºè¿½é—®æŒ‰é’®)
            ...callbacks,           // å±•å¼€æ³¨å…¥æ‰€æœ‰å›è°ƒå‡½æ•°ï¼Œè®©ç»„ä»¶å†…éƒ¨èƒ½è°ƒç”¨
            ...data,                // å±•å¼€æ³¨å…¥ä¼ å…¥çš„è‡ªå®šä¹‰æ•°æ®ï¼Œè¦†ç›–é»˜è®¤å€¼
        },
        zIndex: 2001,               // è®¾ç½®è¾ƒé«˜çš„å±‚çº§ï¼Œç¡®ä¿æ˜¾ç¤ºåœ¨åˆ†ç»„èŠ‚ç‚¹ä¹‹ä¸Š (Group çš„ zIndex æ˜¯ -1)
    }),

    // =========================================================================
    // 2. åˆ›å»ºåˆ†ç»„èŠ‚ç‚¹ (Group Node)
    // èŒè´£ï¼šç”Ÿæˆå¯è§†åŒ–çš„åˆ†ç»„å®¹å™¨ï¼Œä½œä¸ºå…¶ä»–èŠ‚ç‚¹çš„çˆ¶å®¹å™¨
    // =========================================================================
    createGroup: (id: string, pos: {x: number, y: number}, label: string): Node => ({
        id,
        type: 'groupNode',          // æŒ‡å®šèŠ‚ç‚¹ç±»å‹ï¼Œå¯¹åº” App.tsx ä¸­çš„ nodeTypes.groupNode
        position: pos,              // åˆ†ç»„åœ¨ç”»å¸ƒä¸Šçš„ç»å¯¹åæ ‡
        // è®¾ç½®åˆå§‹å°ºå¯¸ï¼šå®½åº¦å›ºå®šï¼Œé«˜åº¦é»˜è®¤ 150 (åç»­ä¼šæ ¹æ®å­èŠ‚ç‚¹è‡ªåŠ¨æ’‘é«˜)
        style: { width: LAYOUT_CONFIG.GROUP_WIDTH, height: 150 },
        data: { label },            // å­˜å‚¨åˆ†ç»„æ ‡é¢˜
        zIndex: -1,                 // è®¾ç½®æä½çš„å±‚çº§ï¼Œç¡®ä¿ä½œä¸º"èƒŒæ™¯"å­˜åœ¨ï¼Œä¸é®æŒ¡å­èŠ‚ç‚¹
    }),

    // =========================================================================
    // 3. åˆ›å»ºè¿çº¿ (Edge) - æ ¸å¿ƒä¿®æ”¹éƒ¨åˆ†
    // èŒè´£ï¼šç”Ÿæˆè¿æ¥ä¸¤ä¸ªèŠ‚ç‚¹çš„çº¿æ¡ï¼Œæ”¯æŒæŒ‡å®šå…·ä½“çš„è¿æ¥æ¡© (Handle)
    // =========================================================================
    createEdge: (
        source: string,                 // æºèŠ‚ç‚¹ ID
        target: string,                 // ç›®æ ‡èŠ‚ç‚¹ ID
        sourceHandle?: string | null,   // ğŸ”¥ æ–°å¢å‚æ•°ï¼šæºèŠ‚ç‚¹çš„è¿æ¥æ¡© ID (å¦‚ 'right-source')
        targetHandle?: string | null    // ğŸ”¥ æ–°å¢å‚æ•°ï¼šç›®æ ‡èŠ‚ç‚¹çš„è¿æ¥æ¡© ID (å¦‚ 'left-source')
    ): Edge => {
        return {
            id: uuidv4(),               // è‡ªåŠ¨ç”Ÿæˆå”¯ä¸€çš„è¿çº¿ ID
            source,                     // ç»‘å®šæºèŠ‚ç‚¹
            target,                     // ç»‘å®šç›®æ ‡èŠ‚ç‚¹
            type: 'editableEdge',       // æŒ‡å®šè¿çº¿ç±»å‹ï¼Œå¯¹åº” App.tsx ä¸­çš„ edgeTypes.editableEdge

            // ğŸ”¥ å…³é”®é€»è¾‘ï¼šå°†å…·ä½“çš„ Handle ID å†™å…¥ React Flow æ•°æ®ç»“æ„
            // å¦‚æœä¸ä¼ è¿™äº› IDï¼ŒReact Flow ä¼šé»˜è®¤è¿æ¥èŠ‚ç‚¹çš„ä¸­å¿ƒï¼Œå¯¼è‡´è¿çº¿é”™ä¹±
            sourceHandle: sourceHandle || undefined,
            targetHandle: targetHandle || undefined,

            // åˆå§‹åŒ–è‡ªå®šä¹‰ä¸šåŠ¡æ•°æ®
            data: {
                controlPointOffset: { x: 0, y: 0 }, // æ™ºèƒ½è·¯å¾„çš„æ§åˆ¶ç‚¹åç§»é‡ (ç”¨äºå¾®è°ƒæ›²çº¿)
                labels: []                          // è¿çº¿æ ‡ç­¾åˆ—è¡¨ï¼Œåˆå§‹ä¸ºç©º
            },

            // åˆå§‹åŒ–è¿çº¿æ ·å¼
            style: {
                stroke: '#B0BEC5',      // é»˜è®¤é¢œè‰²ï¼šæµ…ç°è‰²
                strokeWidth: 2,         // é»˜è®¤çº¿å®½ï¼š2px
            },
            zIndex: 20,                 // å±‚çº§è®¾ç½®ï¼šé«˜äºåˆ†ç»„èƒŒæ™¯ï¼Œä½†ä½äºèŠ‚ç‚¹ (ChatNode: 2001)
        };
    }
};